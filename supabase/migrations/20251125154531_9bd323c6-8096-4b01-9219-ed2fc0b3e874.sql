-- Insert missing micro-services (only if they don't exist)
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM public.service_micro_categories WHERE slug = 'mechanical-ventilation-installation') THEN
    INSERT INTO public.service_micro_categories (id, slug, name, subcategory_id)
    SELECT 
      '00000000-0000-0000-0000-000000000031'::uuid,
      'mechanical-ventilation-installation',
      'Mechanical Ventilation Installation',
      sc.id
    FROM public.service_subcategories sc
    WHERE sc.slug = 'ventilation-air-quality';
  END IF;

  IF NOT EXISTS (SELECT 1 FROM public.service_micro_categories WHERE slug = 'zoning-control-systems') THEN
    INSERT INTO public.service_micro_categories (id, slug, name, subcategory_id)
    SELECT 
      '00000000-0000-0000-0000-000000000042'::uuid,
      'zoning-control-systems',
      'Zoning & Control Systems',
      sc.id
    FROM public.service_subcategories sc
    WHERE sc.slug = 'controls-efficiency';
  END IF;
END $$;

-- Insert question packs (only if they don't exist for this micro_slug and version)
DO $$
BEGIN
  -- Kitchen Extractor Installation
  IF NOT EXISTS (SELECT 1 FROM public.question_packs WHERE micro_slug = 'kitchen-extractor-installation' AND version = 1) THEN
    INSERT INTO public.question_packs (micro_slug, version, status, source, is_active, content)
    VALUES (
      'kitchen-extractor-installation',
      1,
      'approved',
      'ai',
      true,
      '{"id":"00000000-0000-0000-0000-000000000030","category":"hvac","subcategory":"ventilation-air-quality","name":"Kitchen Extractor Installation","slug":"kitchen-extractor-installation","i18nPrefix":"kitchen.extractor.installation","questions":[{"key":"extractor_type","type":"single","i18nKey":"questions.extractor_type.title","required":true,"aiHint":"Determines the style of extractor to be installed.","options":[{"i18nKey":"questions.extractor_type.options.wall_chimney","value":"wall_chimney","order":0},{"i18nKey":"questions.extractor_type.options.island_hood","value":"island_hood","order":1},{"i18nKey":"questions.extractor_type.options.integrated","value":"integrated","order":2},{"i18nKey":"questions.extractor_type.options.downdraft","value":"downdraft","order":3}]},{"key":"cooking_appliance_type","type":"single","i18nKey":"questions.cooking_appliance_type.title","required":true,"aiHint":"Helps identify airflow requirements based on cooking method.","options":[{"i18nKey":"questions.cooking_appliance_type.options.electric_hob","value":"electric","order":0},{"i18nKey":"questions.cooking_appliance_type.options.gas_hob","value":"gas","order":1},{"i18nKey":"questions.cooking_appliance_type.options.induction","value":"induction","order":2}]},{"key":"ducting_requirement","type":"single","i18nKey":"questions.ducting_requirement.title","required":true,"aiHint":"Determines whether ducting exists or must be installed.","options":[{"i18nKey":"questions.ducting_requirement.options.reuse_existing_duct","value":"existing_duct","order":0},{"i18nKey":"questions.ducting_requirement.options.install_new_duct","value":"new_duct","order":1},{"i18nKey":"questions.ducting_requirement.options.recirc_filter","value":"recirculating_filter","order":2}]},{"key":"vent_route_preference","type":"single","i18nKey":"questions.vent_route_preference.title","required":true,"aiHint":"Identifies the route for ventilation ductwork.","options":[{"i18nKey":"questions.vent_route_preference.options.external_wall","value":"external_wall","order":0},{"i18nKey":"questions.vent_route_preference.options.ceiling_void","value":"ceiling_void","order":1},{"i18nKey":"questions.vent_route_preference.options.roof_exit","value":"roof_exit","order":2}]},{"key":"noise_level_preference","type":"single","i18nKey":"questions.noise_level_preference.title","required":true,"aiHint":"Specifies the desired extractor noise level.","options":[{"i18nKey":"questions.noise_level_preference.options.ultra_quiet","value":"ultra_quiet","order":0},{"i18nKey":"questions.noise_level_preference.options.standard_noise","value":"standard","order":1},{"i18nKey":"questions.noise_level_preference.options.not_important","value":"not_important","order":2}]},{"key":"grease_filter_type","type":"single","i18nKey":"questions.grease_filter_type.title","required":true,"aiHint":"Identifies the type of filter system the user wants.","options":[{"i18nKey":"questions.grease_filter_type.options.metal_mesh","value":"metal_mesh","order":0},{"i18nKey":"questions.grease_filter_type.options.baffle_filter","value":"baffle","order":1},{"i18nKey":"questions.grease_filter_type.options.charcoal_filter","value":"charcoal","order":2}]},{"key":"extractor_width","type":"single","i18nKey":"questions.extractor_width.title","required":true,"aiHint":"Indicates the extractor size suitable for the hob.","options":[{"i18nKey":"questions.extractor_width.options.sixty_cm","value":"60cm","order":0},{"i18nKey":"questions.extractor_width.options.ninety_cm","value":"90cm","order":1},{"i18nKey":"questions.extractor_width.options.one_twenty_cm","value":"120cm","order":2}]}]}'::jsonb
    );
  END IF;

  -- Mechanical Ventilation Installation
  IF NOT EXISTS (SELECT 1 FROM public.question_packs WHERE micro_slug = 'mechanical-ventilation-installation' AND version = 1) THEN
    INSERT INTO public.question_packs (micro_slug, version, status, source, is_active, content)
    VALUES (
      'mechanical-ventilation-installation',
      1,
      'approved',
      'ai',
      true,
      '{"id":"00000000-0000-0000-0000-000000000031","category":"hvac","subcategory":"ventilation-air-quality","name":"Mechanical Ventilation Installation","slug":"mechanical-ventilation-installation","i18nPrefix":"mechanical.ventilation.installation","questions":[{"key":"ventilation_system_type","type":"single","i18nKey":"questions.ventilation_system_type.title","required":true,"aiHint":"Identifies which mechanical ventilation system is needed.","options":[{"i18nKey":"questions.ventilation_system_type.options.mev","value":"mev","order":0},{"i18nKey":"questions.ventilation_system_type.options.mvhr","value":"mvhr","order":1},{"i18nKey":"questions.ventilation_system_type.options.single_room_unit","value":"single_room","order":2}]},{"key":"property_structure","type":"single","i18nKey":"questions.property_structure.title","required":true,"aiHint":"Shows how ducts can be routed through the building.","options":[{"i18nKey":"questions.property_structure.options.apartment","value":"apartment","order":0},{"i18nKey":"questions.property_structure.options.villa","value":"villa","order":1},{"i18nKey":"questions.property_structure.options.commercial","value":"commercial","order":2}]},{"key":"ducting_path","type":"single","i18nKey":"questions.ducting_path.title","required":true,"aiHint":"Helps plan duct routing for supply and extract lines.","options":[{"i18nKey":"questions.ducting_path.options.ceiling_void","value":"ceiling_void","order":0},{"i18nKey":"questions.ducting_path.options.attic","value":"attic","order":1},{"i18nKey":"questions.ducting_path.options.wall_voids","value":"wall_voids","order":2}]},{"key":"rooms_to_ventilate","type":"single","i18nKey":"questions.rooms_to_ventilate.title","required":true,"aiHint":"Determines the number of areas requiring extraction and supply.","options":[{"i18nKey":"questions.rooms_to_ventilate.options.one_to_two","value":"1-2","order":0},{"i18nKey":"questions.rooms_to_ventilate.options.three_to_five","value":"3-5","order":1},{"i18nKey":"questions.rooms_to_ventilate.options.whole_home","value":"whole_home","order":2}]},{"key":"heat_recovery_preference","type":"single","i18nKey":"questions.heat_recovery_preference.title","required":true,"aiHint":"Shows whether the client wants heat recovery built into the system.","options":[{"i18nKey":"questions.heat_recovery_preference.options.required","value":"required","order":0},{"i18nKey":"questions.heat_recovery_preference.options.not_required","value":"not_required","order":1}]},{"key":"filter_access_preference","type":"single","i18nKey":"questions.filter_access_preference.title","required":true,"aiHint":"Determines accessibility needs for filter replacement.","options":[{"i18nKey":"questions.filter_access_preference.options.easy_access","value":"easy_access","order":0},{"i18nKey":"questions.filter_access_preference.options.standard_access","value":"standard_access","order":1},{"i18nKey":"questions.filter_access_preference.options.hidden_access","value":"hidden","order":2}]},{"key":"control_system_type","type":"single","i18nKey":"questions.control_system_type.title","required":true,"aiHint":"Defines how the ventilation system should be controlled.","options":[{"i18nKey":"questions.control_system_type.options.basic_switch","value":"basic_switch","order":0},{"i18nKey":"questions.control_system_type.options.humidity_sensor","value":"humidity_sensor","order":1},{"i18nKey":"questions.control_system_type.options.smart_app","value":"smart_app","order":2}]}]}'::jsonb
    );
  END IF;

  -- Energy Efficiency Assessment
  IF NOT EXISTS (SELECT 1 FROM public.question_packs WHERE micro_slug = 'energy-efficiency-assessment' AND version = 1) THEN
    INSERT INTO public.question_packs (micro_slug, version, status, source, is_active, content)
    VALUES (
      'energy-efficiency-assessment',
      1,
      'approved',
      'ai',
      true,
      '{"id":"00000000-0000-0000-0000-000000000040","category":"hvac","subcategory":"controls-efficiency","name":"Energy Efficiency Assessment","slug":"energy-efficiency-assessment","i18nPrefix":"energy.efficiency.assessment","questions":[{"key":"current_system_type","type":"single","i18nKey":"questions.current_system_type.title","required":true,"aiHint":"Identifies the main heating/cooling system to be assessed.","options":[{"i18nKey":"questions.current_system_type.options.split_ac","value":"split_ac","order":0},{"i18nKey":"questions.current_system_type.options.ducted_ac","value":"ducted_ac","order":1},{"i18nKey":"questions.current_system_type.options.heat_pump","value":"heat_pump","order":2},{"i18nKey":"questions.current_system_type.options.boiler_radiators","value":"boiler_radiators","order":3},{"i18nKey":"questions.current_system_type.options.mixed_systems","value":"mixed","order":4}]},{"key":"system_age","type":"single","i18nKey":"questions.system_age.title","required":true,"aiHint":"Gives an indication of likely baseline efficiency and wear.","options":[{"i18nKey":"questions.system_age.options.less_than_5_years","value":"<5","order":0},{"i18nKey":"questions.system_age.options.five_to_ten_years","value":"5-10","order":1},{"i18nKey":"questions.system_age.options.ten_to_fifteen_years","value":"10-15","order":2},{"i18nKey":"questions.system_age.options.more_than_15_years","value":">15","order":3},{"i18nKey":"questions.system_age.options.not_sure","value":"not_sure","order":4}]},{"key":"insulation_level","type":"single","i18nKey":"questions.insulation_level.title","required":true,"aiHint":"Helps evaluate heat loss and potential upgrade impact.","options":[{"i18nKey":"questions.insulation_level.options.basic","value":"basic","order":0},{"i18nKey":"questions.insulation_level.options.moderate","value":"moderate","order":1},{"i18nKey":"questions.insulation_level.options.high_performance","value":"high","order":2},{"i18nKey":"questions.insulation_level.options.not_sure","value":"not_sure","order":3}]},{"key":"window_glazing","type":"single","i18nKey":"questions.window_glazing.title","required":true,"aiHint":"Assesses how much energy is lost through windows.","options":[{"i18nKey":"questions.window_glazing.options.single_glazed","value":"single","order":0},{"i18nKey":"questions.window_glazing.options.double_glazed","value":"double","order":1},{"i18nKey":"questions.window_glazing.options.triple_glazed","value":"triple","order":2},{"i18nKey":"questions.window_glazing.options.mixed","value":"mixed","order":3}]},{"key":"thermostat_control_style","type":"single","i18nKey":"questions.thermostat_control_style.title","required":true,"aiHint":"Shows how the temperature is currently controlled.","options":[{"i18nKey":"questions.thermostat_control_style.options.manual_only","value":"manual","order":0},{"i18nKey":"questions.thermostat_control_style.options.basic_programmer","value":"basic_programmer","order":1},{"i18nKey":"questions.thermostat_control_style.options.smart_thermostat","value":"smart","order":2},{"i18nKey":"questions.thermostat_control_style.options.room_stats_only","value":"room_stats_only","order":3}]},{"key":"typical_temperature_setting","type":"single","i18nKey":"questions.typical_temperature_setting.title","required":true,"aiHint":"Helps understand comfort expectations and consumption habits.","options":[{"i18nKey":"questions.typical_temperature_setting.options.cooler_than_average","value":"cooler","order":0},{"i18nKey":"questions.typical_temperature_setting.options.average","value":"average","order":1},{"i18nKey":"questions.typical_temperature_setting.options.warmer_than_average","value":"warmer","order":2}]},{"key":"main_efficiency_concern","type":"single","i18nKey":"questions.main_efficiency_concern.title","required":true,"aiHint":"Clarifies the primary issue to focus the assessment on.","options":[{"i18nKey":"questions.main_efficiency_concern.options.high_bills","value":"high_bills","order":0},{"i18nKey":"questions.main_efficiency_concern.options.hot_cold_spots","value":"hot_cold_spots","order":1},{"i18nKey":"questions.main_efficiency_concern.options.slow_to_heat_cool","value":"slow_response","order":2},{"i18nKey":"questions.main_efficiency_concern.options.general_optimisation","value":"general_optimisation","order":3}]}]}'::jsonb
    );
  END IF;

  -- Smart Thermostat Installation
  IF NOT EXISTS (SELECT 1 FROM public.question_packs WHERE micro_slug = 'smart-thermostat-installation' AND version = 1) THEN
    INSERT INTO public.question_packs (micro_slug, version, status, source, is_active, content)
    VALUES (
      'smart-thermostat-installation',
      1,
      'approved',
      'ai',
      true,
      '{"id":"00000000-0000-0000-0000-000000000041","category":"hvac","subcategory":"controls-efficiency","name":"Smart Thermostat Installation","slug":"smart-thermostat-installation","i18nPrefix":"smart.thermostat.installation","questions":[{"key":"heating_cooling_system_type","type":"single","i18nKey":"questions.heating_cooling_system_type.title","required":true,"aiHint":"Ensures the smart thermostat is compatible with the system.","options":[{"i18nKey":"questions.heating_cooling_system_type.options.boiler_radiators","value":"boiler_radiators","order":0},{"i18nKey":"questions.heating_cooling_system_type.options.heat_pump_fancoil","value":"heat_pump_fancoil","order":1},{"i18nKey":"questions.heating_cooling_system_type.options.ac_only","value":"ac_only","order":2},{"i18nKey":"questions.heating_cooling_system_type.options.underfloor_heating","value":"underfloor","order":3},{"i18nKey":"questions.heating_cooling_system_type.options.mixed_system","value":"mixed","order":4}]},{"key":"existing_thermostat_setup","type":"single","i18nKey":"questions.existing_thermostat_setup.title","required":true,"aiHint":"Describes the current control arrangement to be upgraded.","options":[{"i18nKey":"questions.existing_thermostat_setup.options.single_wall_thermostat","value":"single_stat","order":0},{"i18nKey":"questions.existing_thermostat_setup.options.multiple_room_stats","value":"multi_stats","order":1},{"i18nKey":"questions.existing_thermostat_setup.options.time_clock_only","value":"time_clock_only","order":2},{"i18nKey":"questions.existing_thermostat_setup.options.none","value":"none","order":3}]},{"key":"number_of_thermostats","type":"single","i18nKey":"questions.number_of_thermostats.title","required":true,"aiHint":"Determines how many smart devices are required.","options":[{"i18nKey":"questions.number_of_thermostats.options.one","value":"1","order":0},{"i18nKey":"questions.number_of_thermostats.options.two_to_three","value":"2-3","order":1},{"i18nKey":"questions.number_of_thermostats.options.four_plus","value":"4+","order":2}]},{"key":"wiring_at_thermostat_location","type":"single","i18nKey":"questions.wiring_at_thermostat_location.title","required":true,"aiHint":"Helps plan wiring changes or additional modules.","options":[{"i18nKey":"questions.wiring_at_thermostat_location.options.two_wire","value":"2_wire","order":0},{"i18nKey":"questions.wiring_at_thermostat_location.options.three_or_more_wires","value":"3+_wire","order":1},{"i18nKey":"questions.wiring_at_thermostat_location.options.not_sure","value":"not_sure","order":2}]},{"key":"wifi_coverage_at_location","type":"single","i18nKey":"questions.wifi_coverage_at_location.title","required":true,"aiHint":"Checks if Wi-Fi is adequate where the thermostat will be installed.","options":[{"i18nKey":"questions.wifi_coverage_at_location.options.strong","value":"strong","order":0},{"i18nKey":"questions.wifi_coverage_at_location.options.moderate","value":"moderate","order":1},{"i18nKey":"questions.wifi_coverage_at_location.options.weak_or_unstable","value":"weak","order":2}]},{"key":"preferred_smart_platform","type":"single","i18nKey":"questions.preferred_smart_platform.title","required":true,"aiHint":"Supports integration with the client existing smart ecosystem.","options":[{"i18nKey":"questions.preferred_smart_platform.options.google_home","value":"google_home","order":0},{"i18nKey":"questions.preferred_smart_platform.options.amazon_alexa","value":"alexa","order":1},{"i18nKey":"questions.preferred_smart_platform.options.apple_home","value":"apple_home","order":2},{"i18nKey":"questions.preferred_smart_platform.options.no_preference","value":"no_pref","order":3}]},{"key":"control_style_preference","type":"single","i18nKey":"questions.control_style_preference.title","required":true,"aiHint":"Clarifies how the client prefers to interact with the system.","options":[{"i18nKey":"questions.control_style_preference.options.app_focus","value":"app_focus","order":0},{"i18nKey":"questions.control_style_preference.options.wall_controller_focus","value":"wall_focus","order":1},{"i18nKey":"questions.control_style_preference.options.mixture_of_both","value":"mixed","order":2}]}]}'::jsonb
    );
  END IF;

  -- Zoning & Control Systems
  IF NOT EXISTS (SELECT 1 FROM public.question_packs WHERE micro_slug = 'zoning-control-systems' AND version = 1) THEN
    INSERT INTO public.question_packs (micro_slug, version, status, source, is_active, content)
    VALUES (
      'zoning-control-systems',
      1,
      'approved',
      'ai',
      true,
      '{"id":"00000000-0000-0000-0000-000000000042","category":"hvac","subcategory":"controls-efficiency","name":"Zoning & Control Systems","slug":"zoning-control-systems","i18nPrefix":"zoning.control.systems","questions":[{"key":"main_system_type","type":"single","i18nKey":"questions.main_system_type.title","required":true,"aiHint":"Ensures the zoning solution matches the underlying HVAC system.","options":[{"i18nKey":"questions.main_system_type.options.ducted_ac_heat_pump","value":"ducted_ac_heat_pump","order":0},{"i18nKey":"questions.main_system_type.options.boiler_radiators","value":"boiler_radiators","order":1},{"i18nKey":"questions.main_system_type.options.underfloor_heating","value":"underfloor","order":2},{"i18nKey":"questions.main_system_type.options.mixed_system","value":"mixed","order":3}]},{"key":"number_of_zones_required","type":"single","i18nKey":"questions.number_of_zones_required.title","required":true,"aiHint":"Defines how many zones the control system must manage.","options":[{"i18nKey":"questions.number_of_zones_required.options.two_zones","value":"2","order":0},{"i18nKey":"questions.number_of_zones_required.options.three_to_four_zones","value":"3-4","order":1},{"i18nKey":"questions.number_of_zones_required.options.five_plus_zones","value":"5+","order":2}]},{"key":"zoning_method_preference","type":"single","i18nKey":"questions.zoning_method_preference.title","required":true,"aiHint":"Clarifies the technical approach to zoning.","options":[{"i18nKey":"questions.zoning_method_preference.options.motorised_valves","value":"motorised_valves","order":0},{"i18nKey":"questions.zoning_method_preference.options.motorised_dampers","value":"motorised_dampers","order":1},{"i18nKey":"questions.zoning_method_preference.options.manifold_actuators","value":"manifold_actuators","order":2},{"i18nKey":"questions.zoning_method_preference.options.not_sure","value":"not_sure","order":3}]},{"key":"priority_areas","type":"single","i18nKey":"questions.priority_areas.title","required":true,"aiHint":"Shows where zoning accuracy and comfort matter most.","options":[{"i18nKey":"questions.priority_areas.options.living_areas","value":"living_areas","order":0},{"i18nKey":"questions.priority_areas.options.bedrooms","value":"bedrooms","order":1},{"i18nKey":"questions.priority_areas.options.kitchen_bathrooms","value":"kitchen_bathrooms","order":2},{"i18nKey":"questions.priority_areas.options.entire_property","value":"entire_property","order":3}]},{"key":"control_interface_preference","type":"single","i18nKey":"questions.control_interface_preference.title","required":true,"aiHint":"Defines how each zone should be controlled day-to-day.","options":[{"i18nKey":"questions.control_interface_preference.options.wall_thermostats_only","value":"wall_stats","order":0},{"i18nKey":"questions.control_interface_preference.options.app_central_control","value":"app_central","order":1},{"i18nKey":"questions.control_interface_preference.options.mix_wall_and_app","value":"mixed","order":2}]},{"key":"existing_zoning_or_controls","type":"single","i18nKey":"questions.existing_zoning_or_controls.title","required":true,"aiHint":"Shows whether this is a new install or upgrade to existing zoning.","options":[{"i18nKey":"questions.existing_zoning_or_controls.options.single_zone_only","value":"single_zone","order":0},{"i18nKey":"questions.existing_zoning_or_controls.options.basic_two_zone","value":"basic_two_zone","order":1},{"i18nKey":"questions.existing_zoning_or_controls.options.full_zoning_needs_upgrade","value":"full_zoning_upgrade","order":2},{"i18nKey":"questions.existing_zoning_or_controls.options.none","value":"none","order":3}]},{"key":"efficiency_focus","type":"single","i18nKey":"questions.efficiency_focus.title","required":true,"aiHint":"Clarifies whether to prioritise comfort, savings, or both.","options":[{"i18nKey":"questions.efficiency_focus.options.max_comfort","value":"max_comfort","order":0},{"i18nKey":"questions.efficiency_focus.options.energy_savings","value":"energy_savings","order":1},{"i18nKey":"questions.efficiency_focus.options.balance_of_both","value":"balanced","order":2}]}]}'::jsonb
    );
  END IF;
END $$;