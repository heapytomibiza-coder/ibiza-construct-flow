name: Contract Validation

on:
  pull_request:
    paths:
      - 'contracts/**'
      - 'src/schemas/**'
      - 'packages/@contracts/**'

jobs:
  validate-contracts:
    name: Validate API Contracts
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate contracts
        run: |
          npm run contracts:openapi
          npm run contracts:types
          npm run contracts:clients

      - name: Check for contract changes
        id: contract-changes
        run: |
          if git diff --exit-code contracts/openapi.yaml packages/@contracts/; then
            echo "No contract changes detected"
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "Contract changes detected"
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Detect breaking changes
        if: steps.contract-changes.outputs.changed == 'true'
        run: |
          npx @readme/openapi-diff \
            origin/main:contracts/openapi.yaml \
            HEAD:contracts/openapi.yaml \
            --fail-on-breaking

      - name: TypeScript compilation check
        run: npx tsc --noEmit --project tsconfig.json

      - name: Lint generated clients
        run: npx eslint 'packages/@contracts/**/*.ts'

      - name: Comment PR with contract changes
        if: steps.contract-changes.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const diff = require('child_process')
              .execSync('git diff contracts/openapi.yaml')
              .toString();
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ“‹ Contract Changes Detected\n\n\`\`\`diff\n${diff}\n\`\`\``
            });
